name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend testing and linting
  backend:
    name: Backend Tests & Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run linting
        run: |
          pip install ruff
          ruff check app/ --select E,F,W --ignore E501
        continue-on-error: true

      - name: Run tests
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=html -m "not integration"
        env:
          # Azure/PostgreSQL environment variables
          ENVIRONMENT: test
          POSTGRES_PASSWORD: test_password
          REDIS_PASSWORD: test_password
          R2_ENDPOINT: https://test.r2.cloudflarestorage.com
          R2_ACCESS_KEY_ID: test_access_key
          R2_SECRET_ACCESS_KEY: test_secret_key
          R2_BUCKET_NAME: test_bucket
          R2_PUBLIC_URL: https://test.r2.cloudflarestorage.com/test_bucket
          GEMINI_API_KEY: test_api_key
          SECRET_KEY: test_secret_key_for_jwt_signing_in_github_actions

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: backend
          name: backend-coverage
        if: always()
        continue-on-error: true

      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: htmlcov/
        if: always()

  # Frontend testing and linting
  frontend:
    name: Frontend Tests & Type Checking
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run check

      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: http://localhost:8080/api/v1

      - name: Run tests (if configured)
        run: |
          if [ -f "vitest.config.ts" ]; then
            npm test -- --run
          else
            echo "Vitest not configured yet, skipping tests"
          fi
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
        if: success()

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Bandit security scan (Backend)
        run: |
          pip install bandit
          bandit -r app/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run npm audit (Frontend)
        working-directory: frontend
        run: npm audit --json > ../npm-audit.json || true
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            npm-audit.json
        if: always()

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, security]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Security: ${{ needs.security.result }}"

      - name: Fail if critical jobs failed
        if: |
          needs.backend.result == 'failure' ||
          needs.frontend.result == 'failure'
        run: exit 1
